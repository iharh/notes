–ü–æ–º–Ω–∏—à—å, –º—ã –∑–∞–ø—É—Å–∫–∞–ª–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã —Å —Ñ–ª–∞–≥–æ–º --memory (https://t.me/Docker_Ninja/104)? –ö–∞–∫ –¥—É–º–∞–µ—à—å, Docker —Å–∞–º –ø–æ —Å–µ–±–µ —Å–ª–µ–¥–∏—Ç –∑–∞ –ø–∞–º—è—Ç—å—é? –ê –≤–æ—Ç –∏ –Ω–µ—Ç! Docker ‚Äî —ç—Ç–æ –≤—Å–µ–≥–æ –ª–∏—à—å –∫—Ä–∞—Å–∏–≤–∞—è –æ–±–µ—Ä—Ç–∫–∞ –Ω–∞–¥ –≤—Å–µ–º–æ–≥—É—â–∏–º Linux —è–¥—Ä–æ–º. 

–ö–æ–Ω–∫—Ä–µ—Ç–Ω–æ –≤ –¥–∞–Ω–Ω–æ–º —Å–ª—É—á–∞–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –º–µ—Ö–∞–Ω–∏–∑–º Control Groups –∏–ª–∏ cgroups

–•–æ—á–µ—à—å –∑–∞–≥–ª—è–Ω—É—Ç—å –ø–æ–¥ –∫–∞–ø–æ—Ç? –ó–∞–ø—É—Å—Ç–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä:
docker run -d --name test-container --memory 512m nginx

–ê —Ç–µ–ø–µ—Ä—å –ø–æ–¥—Å–º–æ—Ç—Ä–∏, —á—Ç–æ —Ç–≤–æ—Ä–∏—Ç—Å—è –≤ –Ω–µ–¥—Ä–∞—Ö —Å–∏—Å—Ç–µ–º—ã:
# –ù–∞–π–¥–µ–º ID –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ 
docker inspect test-container | grep Id

# –ó–∞–≥–ª—è–Ω–µ–º –≤ cgroups
ls /sys/fs/cgroup/memory/docker/

# –ù–∞–π–¥–µ–º –≤—ã—Å—Ç–∞–≤–ª–µ–Ω–Ω—ã–π –Ω–∞–º–∏ –ª–∏–º–∏—Ç –ø–∞–º—è—Ç–∏
cat /sys/fs/cgroup/memory/docker/conatainer_id/memory.limit_in_bytes

–•–æ–±–∞, –∏ —Ç–∞–º —Ü–µ–ª–∞—è –∏–µ—Ä–∞—Ä—Ö–∏—è –ø–∞–ø–æ–∫! –ö–∞–∂–¥–∞—è ‚Äî —ç—Ç–æ –æ—Ç–¥–µ–ª—å–Ω–∞—è cgroup –¥–ª—è —Ç–≤–æ–µ–≥–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞. Docker –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–∑–¥–∞–µ—Ç –≥—Ä—É–ø–ø—ã:
- –ü–∞–º—è—Ç–∏ (/sys/fs/cgroup/memory/docker/)
- CPU (/sys/fs/cgroup/cpu/docker/)
- –î–∏—Å–∫–æ–≤–æ–≥–æ I/O (/sys/fs/cgroup/blkio/docker/)

–ó–∞—á–µ–º —ç—Ç–æ –∑–Ω–∞—Ç—å? 
–ö–æ–≥–¥–∞ —Ç–≤–æ–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –≤–Ω–µ–∑–∞–ø–Ω–æ –ø—Ä–∏–±–∏–≤–∞–µ—Ç—Å—è –∏–ª–∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å—Ç—Ä–∞–Ω–Ω–æ—Å—Ç–∏ —Å —Ä–µ—Å—É—Ä—Å–∞–º–∏, –∏–º–µ–Ω–Ω–æ –≤ —ç—Ç–∏ —Ñ–∞–π–ª—ã —Å—Ç–æ–∏—Ç –∑–∞–≥–ª—è–Ω—É—Ç—å. –ü–æ–º–Ω–∏—à—å docker stats (https://t.me/Docker_Ninja/70)? –û–Ω –∫–∞–∫ —Ä–∞–∑ —á–∏—Ç–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –∏–∑ cgroups! –ê –µ—Å–ª–∏ –≤–¥—Ä—É–≥ docker cli (https://t.me/Docker_Ninja/17) –ø–æ –∫–∞–∫–æ–π-—Ç–æ –ø—Ä–∏—á–∏–Ω–µ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã, —Ç–æ —Ä–∞—Å–∫—É—Ä–∏–≤–∞—Ç—å –æ—Å—Ç–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ —Ñ–∞–π–ª—ã cgroups.

–ê –µ—â–µ —ç—Ç–æ –æ–±—ä—è—Å–Ω—è–µ—Ç, –ø–æ—á–µ–º—É –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã —Ä–∞–±–æ—Ç–∞—é—Ç —Ç–æ–ª—å–∫–æ –Ω–∞ Linux ‚Äî –±–µ–∑ cgroups –∏ namespaces (https://t.me/Docker_Ninja/108) –≤—Å—è –∏–∑–æ–ª—è—Ü–∏—è –ø—Ä–µ–≤—Ä–∞—â–∞–µ—Ç—Å—è –≤ —Ç—ã–∫–≤—É üéÉ

**************************************************************************************************

–ü–æ –≤–∞—à–∏–º –∑–∞—è–≤–∫–∞–º –≤ –ø–æ—Å—Ç–µ –ø—Ä–æ cgroups (https://t.me/Docker_Ninja/124) –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º —É–≥–ª—É–±–ª—è—Ç—å—Å—è –≤ –∫—Ä–æ–ª–∏—á—å—é –Ω–æ—Ä—É –¥–∞–ª—å—à–µ. –ß—Ç–æ –∂, –º–æ–∏ –¥–æ—Ä–æ–≥–∏–µ –ª—é–±–∏—Ç–µ–ª–∏ –ø–æ–∫–æ–ø–∞—Ç—å—Å—è –≤ –∫–∏—à–æ—á–∫–∞—Ö, –¥–∞–≤–∞–π—Ç–µ –ø—Ä–∏—Å—Ç—É–ø–∏–º. üôèüèª

üîç –ù–∞—Ö–æ–¥–∏–º –Ω—É–∂–Ω—É—é cgroup
–ò—â–µ–º ID –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞, —á—Ç–æ–±—ã –∑–Ω–∞—Ç—å –≤ –∫–∞–∫—É—é –ø–∞–ø–∫—É —Å—Ç—É—á–∞—Ç—å
ddocker inspect test-container | grep Id

ü§ø –¢–µ–ø–µ—Ä—å –Ω—ã—Ä—è–µ–º –≤ –µ–≥–æ –º–µ—Ç—Ä–∏–∫–∏:
üíæ –ú–µ—Ç—Ä–∏–∫–∏ –ø–∞–º—è—Ç–∏
# –¢–µ–∫—É—â–µ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø–∞–º—è—Ç–∏
cat /sys/fs/cgroup/memory/docker/CONTAINER_ID/memory.usage_in_bytes

# –õ–∏–º–∏—Ç –ø–∞–º—è—Ç–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
cat /sys/fs/cgroup/memory/docker/CONTAINER_ID/memory.limit_in_bytes

# –î–µ—Ç–∞–ª—å–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–∞–º—è—Ç–∏
cat /sys/fs/cgroup/memory/docker/CONTAINER_ID/memory.stat

# –ü–∏–∫–æ–≤–æ–µ –ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–µ –ø–∞–º—è—Ç–∏
cat /sys/fs/cgroup/memory/docker/CONTAINER_ID/memory.max_usage_in_bytes

# Swap –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ
cat /sys/fs/cgroup/memory/docker/CONTAINER_ID/memory.memsw.usage_in_bytes

üñ• CPU –º–µ—Ç—Ä–∏–∫–∏
# –û–±—â–µ–µ –≤—Ä–µ–º—è CPU –≤ –Ω–∞–Ω–æ—Å–µ–∫—É–Ω–¥–∞—Ö
cat /sys/fs/cgroup/cpuacct/docker/CONTAINER_ID/cpuacct.usage

# CPU usage –ø–æ —è–¥—Ä–∞–º
cat /sys/fs/cgroup/cpuacct/docker/CONTAINER_ID/cpuacct.usage_percpu

# –î–µ—Ç–∞–ª—å–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ CPU
cat /sys/fs/cgroup/cpu/docker/CONTAINER_ID/cpu.stat

# –í—Ä–µ–º—è –≤ user/system mode
cat /sys/fs/cgroup/cpuacct/docker/CONTAINER_ID/cpuacct.stat

# CPU throttling —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
cat /sys/fs/cgroup/cpu/docker/CONTAINER_ID/cpu.throttling_data

üíø Block I/O –º–µ—Ç—Ä–∏–∫–∏
# –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ —á—Ç–µ–Ω–∏—é/–∑–∞–ø–∏—Å–∏
cat /sys/fs/cgroup/blkio/docker/CONTAINER_ID/blkio.throttle.io_service_bytes

# IOPS —Å—á–µ—Ç—á–∏–∫–∏
cat /sys/fs/cgroup/blkio/docker/CONTAINER_ID/blkio.throttle.io_serviced

# –í—Ä–µ–º—è –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏—è I/O
cat /sys/fs/cgroup/blkio/docker/CONTAINER_ID/blkio.time

ü•∂–ù–∞—à –ª—é–±–∏–º—ã–π freezer
# –¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
cat /sys/fs/cgroup/freezer/docker/CONTAINER_ID/freezer.state

# PID —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–æ–≥–æ –ø—Ä–æ—Ü–µ—Å—Å–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
cat /sys/fs/cgroup/freezer/docker/CONTAINER_ID/cgroup.procs

# –°–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –ø–æ—Ç–æ–∫–æ–≤ (threads), –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–∞—â–∏—Ö –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—É (–≤ —Å—Ç–∞—Ä—ã—Ö –≤–µ—Ä—Å–∏—è—Ö —è–¥—Ä–∞).
cat /sys/fs/cgroup/freezer/docker/CONTAINER_ID/tasks

–ö–∞–∫ –º—ã —É–∂–µ —Ä–∞–∑–æ–±—Ä–∞–ª–∏ –≤ –ø–µ—Ä–≤–æ–º –ø–æ—Å—Ç–µ –ø—Ä–æ cgroups (https://t.me/Docker_Ninja/124), docker stats (https://t.me/Docker_Ninja/70) –∏ —Ñ–ª–∞–≥ --memory (https://t.me/Docker_Ninja/103) —Ä–∞–±–æ—Ç–∞—é—Ç –∏–º–µ–Ω–Ω–æ —Å —ç—Ç–∏–º–∏ —Ñ–∞–π–ª–∞–º–∏. 
–ù–æ, –ª–∏–Ω—É–∫—Å –Ω–µ –ª–∏–Ω—É–∫—Å, –µ—Å–ª–∏ –±—ã –≤—Å–µ –±—ã–ª–æ —Ç–∞–∫ –ø—Ä–æ—Å—Ç–æ... –î–∞–Ω–Ω–∞—è —Ñ–∞–π–ª–æ–≤–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –∞–∫—Ç—É–∞–ª—å–Ω–∞ –¥–ª—è cgroups v1. –ü–æ—ç—Ç–æ–º—É, —Å—Ç–∞–≤—å üî• –µ—Å–ª–∏ —Ö–æ—á–µ—à—å —É–∑–Ω–∞—Ç—å –ø—Ä–æ —Ç–æ, –∫–∞–∫ —Ä–∞–±–æ—Ç–∞—Ç—å —Å —Ñ–∞–π–ª–∞–º–∏ cgroups v2.

**************************************************************************************************

–ù—É –∏ –∑–∞–∫–ª—é—á–∏—Ç–µ–ª—å–Ω—ã–π –ø–æ—Å—Ç –ø—Ä–æ —Ñ–∞–π–ª—ã cgroups (–ø–µ—Ä–≤—ã–π (https://t.me/Docker_Ninja/124), –≤—Ç–æ—Ä–æ–π (https://t.me/Docker_Ninja/129)).

–ù–∞—á–∏–Ω–∞—è —Å –≤–µ—Ä—Å–∏–∏ —è–¥—Ä–∞ Linux 4.5 –º—ã –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤—É–µ–º —Å cgroups v2, –∫–æ—Ç–æ—Ä—ã–π —Å—Ç–∞–ª –±–æ–ª–µ–µ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π, —á–µ–º –ø–µ—Ä–≤–∞—è –≤–µ—Ä—Å–∏—è. 

–í—ã–≥–ª—è–¥–∏—Ç —ç—Ç–æ –¥–µ–ª–æ —Ç–∞–∫:
üéØ–û–ø—Ä–µ–¥–µ–ª—è–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –Ω–∞—à–µ–≥–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞:
# –ó–∞–ø—É—Å–∫–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
docker run -d --name test-app nginx

# –ü—É—Ç—å –∫ cgroup –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
CGROUP_PATH="/sys/fs/cgroup/system.slice/docker-$(docker inspect -f '{{.Id}}' test-app).scope"

üß†Memory
# –¢–µ–∫—É—â–µ–µ –ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–µ –ø–∞–º—è—Ç–∏
cat $CGROUP_PATH/memory.current
# 52428800 (50MB –≤ –±–∞–π—Ç–∞—Ö)

# –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–µ —Å –º–æ–º–µ–Ω—Ç–∞ —Å—Ç–∞—Ä—Ç–∞
cat $CGROUP_PATH/memory.max
# max (–±–µ–∑ –ª–∏–º–∏—Ç–æ–≤)

# –î–µ—Ç–∞–ª—å–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–∞–º—è—Ç–∏
cat $CGROUP_PATH/memory.stat
# anon 12582912
# file 8388608
# kernel_stack 32768

‚ö°Ô∏èCPU
# –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è CPU
cat $CGROUP_PATH/cpu.stat
# usage_usec 1542340
# user_usec 890123
# system_usec 652217

# –ü–æ–º–µ—á–µ–Ω –ª–∏ –ø—Ä–æ—Ü–µ—Å—Å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –∫–∞–∫ "—Å –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–º –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–æ–º"
cat $CGROUP_PATH/cpu.idle

# –¢–µ–∫—É—â–∏–π –≤–µ—Å –ø—Ä–æ—Ü–µ—Å—Å–∞
cat $CGROUP_PATH/cpu.weight
# 100

üíæI/O
# –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –≤–≤–æ–¥–∞-–≤—ã–≤–æ–¥–∞
cat $CGROUP_PATH/io.stat
# 8:0 rbytes=1048576 wbytes=4096 rios=64 wios=8

# –¢–µ–∫—É—â–∏–π I/O pressure
cat $CGROUP_PATH/io.pressure
# some avg10=0.00 avg60=0.00 avg300=0.00 total=0

üßäFreezer
# –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
cat $CGROUP_PATH/cgroup.freeze
# 0 (—Ä–∞–∑–º–æ—Ä–æ–∂–µ–Ω)

# –ó–∞–º–æ—Ä–∞–∂–∏–≤–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –±–µ–∑ docker cli
echo 1 > $CGROUP_PATH/cgroup.freeze
# –ü–æ—Å–ª–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –ø–æ–ø—Ä–æ–±—É–π –∑–∞–π—Ç–∏ –≤ —Ç–µ—Ä–º–∏–Ω–∞–ª –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ
cat $CGROUP_PATH/cgroup.freeze
# 1 (–∑–∞–º–æ—Ä–æ–∂–µ–Ω)

# –†–∞–∑–º–æ—Ä–∞–∂–∏–≤–∞–µ–º –æ–±—Ä–∞—Ç–Ω–æ
echo 0 > $CGROUP_PATH/cgroup.freeze

üö®–ö–æ–Ω—Ç—Ä–æ–ª—å –ø—Ä–æ—Ü–µ—Å—Å–æ–≤
# –°–ø–∏—Å–æ–∫ PID-–æ–≤ –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ  
cat $CGROUP_PATH/cgroup.procs
# 1234
# 1235

# –°–æ–±—ã—Ç–∏—è cgroup (—É–±–∏–π—Å—Ç–≤–∞ OOM, –º–∏–≥—Ä–∞—Ü–∏–∏ –∏ –ø—Ä–æ—á.)
cat $CGROUP_PATH/cgroup.events
# populated 1
# frozen 0

–í –±–æ–ª—å—à–∏–Ω—Å—Ç–≤–µ —Å–ª—É—á–∞–µ–≤, –≤—ã —Å—Ç–æ–ª–∫–Ω–µ—Ç–µ—Å—å –∏–º–µ–Ω–Ω–æ —Å cgroups v2. –ü–æ—ç—Ç–æ–º—É –ø–æ–ª–µ–∑–Ω–æ —É–≥–ª—É–±–∏—Ç—å—Å—è –∏–º–µ–Ω–Ω–æ –≤ —ç—Ç–æ—Ç –≤–∞—Ä–∏–∞–Ω—Ç –∫–∞—Ç–∞–ª–æ–≥–æ–≤.

–ö–∞–∫ –≤–∏–¥–∏–º, –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø–æ—á—Ç–∏ –Ω–µ –∫–æ—Å–Ω—É–ª–∏—Å—å –º–µ—Ç—Ä–∏–∫ –ø–∞–º—è—Ç–∏. –ù–æ –≤–æ—Ç –ø–æ –æ—Å—Ç–∞–ª—å–Ω—ã–º –µ—Å—Ç—å –¥–æ–≤–æ–ª—å–Ω–æ –º–Ω–æ–≥–æ –Ω—é–∞–Ω—Å–æ–≤. –ò –µ—Å–ª–∏ –∫–æ–ø–∞—Ç—å –≤ —ç—Ç—É —Å—Ç–æ—Ä–æ–Ω—É –µ—â–µ –≥–ª—É–±–∂–µ, —Ç–æ –º—ã, –≤ –ª—é–±–æ–º —Å–ª—É—á–∞–µ, –≤—ã–π–¥–µ–º –Ω–∞ –ª–∏–Ω—É–∫—Å. –ê —ç—Ç–æ —É–∂–µ –≤—ã—Ö–æ–¥–∏—Ç –∑–∞ —Ä–∞–º–∫–∏ —Ç–µ–º–∞—Ç–∏–∫–∏ –¥–∞–Ω–Ω–æ–≥–æ –∫–∞–Ω–∞–ª–∞. –î–∞ –∏ —Å–∞–º –ª–∏–Ω—É–∫—Å - —ç—Ç–æ —É–∂ –æ—á–µ–Ω—å –≥–ª—É–±–æ–∫–∞—è —à—Ç—É–∫–∞, –∫–æ—Ç–æ—Ä—É—é –Ω–∞–¥–æ —Ä–∞–∑–±–∏—Ä–∞—Ç—å –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º –∫–∞–Ω–∞–ª–µ. 
