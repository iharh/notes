******************************************************************************************************************************************************
–ê–Ω—Ç–∏–ø–∞—Ç—Ç–µ—Ä–Ω: N+1 –∑–∞–ø—Ä–æ—Å–æ–≤ ‚Äî –∫–∞–∫ –∑–∞–º–µ—Ç–∏—Ç—å –∏ –ø–æ—á–∏–Ω–∏—Ç—å

–í—ã –±–µ—Ä—ë—Ç–µ —Å–ø–∏—Å–æ–∫ —Å—É—â–Ω–æ—Å—Ç–µ–π, –∞ –ø–æ—Ç–æ–º –≤ —Ü–∏–∫–ª–µ –¥–ª—è –∫–∞–∂–¥–æ–π —Ç—è–Ω–µ—Ç–µ —Å–≤—è–∑–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ. –í –∏—Ç–æ–≥–µ - 1 –∑–∞–ø—Ä–æ—Å –∑–∞ ¬´—Ä–æ–¥–∏—Ç–µ–ª—è–º–∏¬ª + N –∑–∞–ø—Ä–æ—Å–æ–≤ –∑–∞ ¬´–¥–µ—Ç—å–º–∏¬ª. –õ–∞—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å —Ä–∞—Å—Ç—ë—Ç –ª–∏–Ω–µ–π–Ω–æ –æ—Ç —Ä–∞–∑–º–µ—Ä–∞ –≤—ã–±–æ—Ä–∫–∏.

–°–∏–º–ø—Ç–æ–º—ã

- –í –ª–æ–≥–∞—Ö –º–Ω–æ–≥–æ –æ–¥–∏–Ω–∞–∫–æ–≤—ã—Ö –∫–æ—Ä–æ—Ç–∫–∏—Ö –∑–∞–ø—Ä–æ—Å–æ–≤.
- –ö–æ–ª-–≤–æ –∑–∞–ø—Ä–æ—Å–æ–≤ ‚âà —Ä–∞–∑–º–µ—Ä—É —Å–ø–∏—Å–∫–∞.
- –°—Ç—Ä–∞–Ω–∏—Ü–∞/endpoint —Å–∏–ª—å–Ω–æ ¬´–∑–∞–º–µ–¥–ª—è–µ—Ç—Å—è¬ª –ø—Ä–∏ —Ä–æ—Å—Ç–µ –¥–∞–Ω–Ω—ã—Ö.

–ü–ª–æ—Ö–æ–π –ø—Ä–∏–º–µ—Ä (SQL + –ø—Å–µ–≤–¥–æ–∫–æ–¥)


-- –ë–µ—Ä—ë–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
SELECT id, name FROM users WHERE active = true;

-- –ü–æ—Ç–æ–º –≤ —Ü–∏–∫–ª–µ –ø–æ –∫–∞–∂–¥–æ–º—É:
SELECT count(*) FROM orders WHERE user_id = :id;


–ü—Ä–∞–≤–∏–ª—å–Ω–æ (SQL, PostgreSQL) ‚Äî —Å–µ—Ç–µ–≤–æ–µ –º—ã—à–ª–µ–Ω–∏–µ:


SELECT u.id,
       u.name,
       count(o.*) AS orders_cnt
FROM users u
LEFT JOIN orders o ON o.user_id = u.id
WHERE u.active = true
GROUP BY u.id, u.name;


Django ORM


# –ü–ª–æ—Ö–æ: –≤ —à–∞–±–ª–æ–Ω–µ/—Ü–∏–∫–ª–µ –æ–±—Ä–∞—â–∞–µ–º—Å—è –∫ user.orders -> N+1
users = User.objects.filter(active=True)

# –•–æ—Ä–æ—à–æ: –ø–æ–¥–≥—Ä—É–∑–∏–º —Å–≤—è–∑–∏ –∑–∞—Ä–∞–Ω–µ–µ
users = (User.objects
         .filter(active=True)
         .prefetch_related('orders'))          # –¥–ª—è 1:N
# –¥–ª—è 1:1 / ForeignKey –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ select_related('profile')

# –ê–≥—Ä–µ–≥–∞—Ü–∏—è –±–µ–∑ —Ü–∏–∫–ª–∞
from django.db.models import Count
users = (User.objects.filter(active=True)
         .annotate(orders_cnt=Count('orders')))


SQLAlchemy


from sqlalchemy.orm import selectinload, joinedload

# 1:N ‚Äî –±–µ–∑–æ–ø–∞—Å–Ω–µ–µ selectinload (–±–∞—Ç—á–∏—Ä—É–µ—Ç IN (...))
users = (session.query(User)
         .options(selectinload(User.orders))
         .filter(User.active.is_(True))
         .all())

# 1:1 ‚Äî joinedload
user = (session.query(User)
        .options(joinedload(User.profile))
        .get(user_id))


–ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ —Å–æ–≤–µ—Ç—ã

- –õ–æ–≥–∏—Ä—É–π—Ç–µ –∫–æ–ª-–≤–æ –∑–∞–ø—Ä–æ—Å–æ–≤ –Ω–∞ —ç–Ω–¥–ø–æ–π–Ω—Ç/—Å—Ç—Ä–∞–Ω–∏—Ü—É. –í Django - django-debug-toolbar, assertNumQueries –≤ —Ç–µ—Å—Ç–∞—Ö; –≤ SQLAlchemy - echo/–∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –ª–æ–≥–≥–µ—Ä–æ–º.
- –ò–Ω–¥–µ–∫—Å—ã: –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ orders(user_id); –µ—Å–ª–∏ —Ñ–∏–ª—å—Ç—Ä—É–µ—Ç–µ –ø–æ —Å—Ç–∞—Ç—É—Å—É - —Å–æ—Å—Ç–∞–≤–Ω–æ–π (user_id, status).
- –ë–∞—Ç—á–∏–Ω–≥ –≤–º–µ—Å—Ç–æ —Ü–∏–∫–ª–æ–≤: —Ç—è–Ω–∏—Ç–µ –¥–µ—Ç–µ–π –æ–¥–Ω–∏–º –∑–∞–ø—Ä–æ—Å–æ–º WHERE user_id IN (...), –∑–∞—Ç–µ–º –º–∞–ø—å—Ç–µ –≤ –ø–∞–º—è—Ç–∏.
- –û—Å—Ç–æ—Ä–æ–∂–Ω–æ —Å joinedload –¥–ª—è 1:N –Ω–∞ –±–æ–ª—å—à–∏—Ö –≤—ã–±–æ—Ä–∫–∞—Ö - —Ä–∏—Å–∫ ¬´–≤–∑—Ä—ã–≤–∞¬ª —Å—Ç—Ä–æ–∫. –î–ª—è 1:N —á–∞—â–µ –≤—ã–±–∏—Ä–∞–π—Ç–µ selectinload.
- –ö–æ–ª–æ–Ω–∫–∏ –ø–æ –¥–µ–ª—É: –Ω–µ —Ç–∞—â–∏—Ç–µ SELECT *, –±–µ—Ä–∏—Ç–µ —Ç–æ–ª—å–∫–æ –Ω—É–∂–Ω—ã–µ –ø–æ–ª—è.
- –ü–∞–≥–∏–Ω–∞—Ü–∏—è: —É–º–µ–Ω—å—à–∞–µ—Ç N –∏ –¥–∞–≤–ª–µ–Ω–∏–µ –Ω–∞ —Å–µ—Ç—å/–ø–∞–º—è—Ç—å.
- EXPLAIN (ANALYZE, BUFFERS) - –ø—Ä–æ–≤–µ—Ä—è–π—Ç–µ –ø–ª–∞–Ω—ã –∏ –∫–∞—Ä–¥–∏–Ω–∞–ª—å–Ω–æ—Å—Ç–∏.


üí°–î—É–º–∞–π—Ç–µ –Ω–∞–±–æ—Ä–∞–º–∏, –∞ –Ω–µ —Ü–∏–∫–ª–∞–º–∏. Eager loading + –∞–≥—Ä–µ–≥–∞—Ç—ã –∑–∞–∫—Ä—ã–≤–∞—é—Ç 90% —Å–ª—É—á–∞–µ–≤ N+1. –ù–∞—Å—Ç—Ä–æ–π—Ç–µ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –∑–∞–ø—Ä–æ—Å–æ–≤ - –∏ –ª–æ–≤–∏—Ç–µ –ø—Ä–æ–±–ª–µ–º—É –¥–æ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞.

–°–æ—Ö—Ä–∞–Ω–∏, —á—Ç–æ–±—ã –Ω–µ –Ω–∞—Å—Ç—É–ø–∏—Ç—å —Å–Ω–æ–≤–∞. –ü–æ–¥–µ–ª–∏—Å—å —Å –∫–æ–ª–ª–µ–≥–∞–º–∏. –ê –∫–∞–∫ –≤—ã –ª–æ–≤–∏—Ç–µ N+1 —É —Å–µ–±—è?
